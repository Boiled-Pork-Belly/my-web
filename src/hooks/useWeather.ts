// =====================================================================
// ğŸ“ íŒŒì¼ëª…: useWeather.ts
// ğŸ“ ìœ„ì¹˜: src/hooks/useWeather.ts
// ğŸ¯ ì—­í• : ë‚ ì”¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° + AI ì˜·ì°¨ë¦¼ ì¶”ì²œ ë°›ê¸°
// ğŸ“ ì„¤ëª…: ì´ íŒŒì¼ì€ "ì»¤ìŠ¤í…€ í›…(Custom Hook)"ì…ë‹ˆë‹¤.
//         í›…ì€ Reactì˜ ìƒíƒœ(state)ì™€ ë¡œì§ì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ë¬¶ì–´ë†“ì€ í•¨ìˆ˜ì˜ˆìš”.
//         ì´ í›…ì„ importí•˜ë©´ ì–´ë–¤ ì»´í¬ë„ŒíŠ¸ì—ì„œë“  ë‚ ì”¨ ê¸°ëŠ¥ì„ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
// =====================================================================

// ---------------------------------------------------------------------
// 1. í•„ìš”í•œ ë„êµ¬ë“¤ ë¶ˆëŸ¬ì˜¤ê¸° (import)
// ---------------------------------------------------------------------

// useState: Reactì—ì„œ "ë³€í•˜ëŠ” ê°’(ìƒíƒœ)"ì„ ê´€ë¦¬í•˜ëŠ” í•¨ìˆ˜
// ì˜ˆ) const [count, setCount] = useState(0);
//     count = í˜„ì¬ ê°’, setCount = ê°’ì„ ë°”ê¾¸ëŠ” í•¨ìˆ˜
import { useState } from 'react';

// axios: HTTP ìš”ì²­ì„ ì‰½ê²Œ ë³´ë‚´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
// fetchë³´ë‹¤ ì‚¬ìš©í•˜ê¸° í¸í•˜ê³ , ìë™ìœ¼ë¡œ JSON íŒŒì‹±í•´ì¤Œ
import axios from 'axios';

// GoogleGenerativeAI: êµ¬ê¸€ì˜ Gemini AIë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ê³µì‹ SDK
// ì´ê±¸ë¡œ AIì—ê²Œ ì§ˆë¬¸í•˜ê³  ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŒ
import { GoogleGenerativeAI } from "@google/generative-ai";

// ---------------------------------------------------------------------
// 2. í›… í•¨ìˆ˜ ì •ì˜ ì‹œì‘
// ---------------------------------------------------------------------

// export default: ì´ í•¨ìˆ˜ë¥¼ ë‹¤ë¥¸ íŒŒì¼ì—ì„œ importí•  ìˆ˜ ìˆê²Œ ë‚´ë³´ëƒ„
// function useWeather(): ì»¤ìŠ¤í…€ í›… ì´ë¦„ (useë¡œ ì‹œì‘í•˜ëŠ” ê²Œ ê·œì¹™!)
export default function useWeather() {

    // ===================================================================
    // 3. ìƒíƒœ(State) ë°”êµ¬ë‹ˆë“¤ ì„ ì–¸
    // ===================================================================
    // useState<íƒ€ì…>(ì´ˆê¸°ê°’): ìƒíƒœ ë³€ìˆ˜ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜
    // [ë³€ìˆ˜ëª…, ì„¸í„°í•¨ìˆ˜] = useState(ì´ˆê¸°ê°’) í˜•íƒœë¡œ ì‚¬ìš©
    // ì„¸í„° í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ Reactê°€ ìë™ìœ¼ë¡œ í™”ë©´ì„ ë‹¤ì‹œ ê·¸ë¦¼!

    // í˜„ì¬ ê¸°ì˜¨ì„ ë‹´ëŠ” ë°”êµ¬ë‹ˆ
    // number | null: ìˆ«ì ë˜ëŠ” null (ì•„ì§ ë°ì´í„° ì—†ì„ ë•Œ)
    // ì´ˆê¸°ê°’: null (ì²˜ìŒì—” ë°ì´í„°ê°€ ì—†ìœ¼ë‹ˆê¹Œ)
    const [currentTemp, setCurrentTemp] = useState<number | null>(null);

    // ì‹œê°„ë³„ ê¸°ì˜¨ ë°°ì—´ì„ ë‹´ëŠ” ë°”êµ¬ë‹ˆ
    // number[]: ìˆ«ìë“¤ì˜ ë°°ì—´ (ì˜ˆ: [3.2, 4.1, 5.5, ...])
    // ì´ˆê¸°ê°’: [] (ë¹ˆ ë°°ì—´)
    const [hourlyTemps, setHourlyTemps] = useState<number[]>([]);

    // AIê°€ ì¶”ì²œí•´ì¤€ ì˜·ì°¨ë¦¼ ë©˜íŠ¸ë¥¼ ë‹´ëŠ” ë°”êµ¬ë‹ˆ
    // string | null: ë¬¸ìì—´ ë˜ëŠ” null
    const [aiRecommendation, setAiRecommendation] = useState<string | null>(null);

    // ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€ë¥¼ ë‹´ëŠ” ë°”êµ¬ë‹ˆ
    // ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ trueê°€ ë˜ê³ , ë°ì´í„° ë°›ìœ¼ë©´ falseê°€ ë¨
    const [loading, setLoading] = useState(false);

    // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë‹´ëŠ” ë°”êµ¬ë‹ˆ
    // ì •ìƒì´ë©´ null, ì—ëŸ¬ ë°œìƒí•˜ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ë¬¸ìì—´
    const [error, setError] = useState<string | null>(null);

    // ===================================================================
    // 4. í•¨ìˆ˜ A: ë°ì´í„° ì‹¬ë¶€ë¦„ê¾¼ (getWeatherData)
    // ===================================================================
    // ğŸ¯ ì—­í• : ë‚ ì”¨ APIì—ì„œ ë°ì´í„°ë§Œ ê°€ì ¸ì™€ì„œ ë¦¬í„´
    // ğŸ“ íŠ¹ì§•: Stateë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (ìˆœìˆ˜ í•¨ìˆ˜)
    //         ì™œ? í•¨ìˆ˜ í•˜ë‚˜ê°€ í•˜ë‚˜ì˜ ì—­í• ë§Œ í•˜ê²Œ í•˜ë ¤ê³ ! (ë‹¨ì¼ ì±…ì„ ì›ì¹™)

    // async: ì´ í•¨ìˆ˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ì˜ˆìš” (ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ì‘ì—… ì²˜ë¦¬)
    // await: ê²°ê³¼ê°€ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤!
    const getWeatherData = async () => {
        // API ì£¼ì†Œ (Open-Meteo: ë¬´ë£Œ ë‚ ì”¨ API)
        // latitude=37.5, longitude=126.9 â†’ ì„œìš¸ ì¢Œí‘œ
        // current_weather=true â†’ í˜„ì¬ ë‚ ì”¨ í¬í•¨
        // hourly=temperature_2m â†’ ì‹œê°„ë³„ ê¸°ì˜¨ í¬í•¨
        const url = "https://api.open-meteo.com/v1/forecast?latitude=37.5&longitude=126.9&current_weather=true&hourly=temperature_2m";

        // axios.get(url): GET ìš”ì²­ ë³´ë‚´ê¸°
        // await: ì‘ë‹µì´ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        const response = await axios.get(url);

        // response.data: ì„œë²„ê°€ ë³´ë‚´ì¤€ JSON ë°ì´í„°
        // return: ì´ ë°ì´í„°ë¥¼ í•¨ìˆ˜ ë°–ìœ¼ë¡œ ë˜ì ¸ì¤Œ
        return response.data;
    };

    // ===================================================================
    // 5. í•¨ìˆ˜ C: AI ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ (getAiRecommendation)
    // ===================================================================
    // ğŸ¯ ì—­í• : ê¸°ì˜¨ì„ ë°›ì•„ì„œ Geminiì—ê²Œ ì˜·ì°¨ë¦¼ ì¶”ì²œì„ ë¬¼ì–´ë´„
    // ğŸ“ ë§¤ê°œë³€ìˆ˜: temp (ê¸°ì˜¨ ìˆ«ì)

    const getAiRecommendation = async (temp: number) => {
        try {
            // -----------------------------------------------------------------
            // Step 1: Gemini AI ì—°ê²°í•˜ê¸°
            // -----------------------------------------------------------------

            // import.meta.env.VITE_GEMINI_KEY: 
            //   .env íŒŒì¼ì— ì €ì¥ëœ API í‚¤ë¥¼ ê°€ì ¸ì˜´
            //   Viteì—ì„œëŠ” VITE_ ì ‘ë‘ì‚¬ê°€ ë¶™ì€ í™˜ê²½ë³€ìˆ˜ë§Œ ì ‘ê·¼ ê°€ëŠ¥!
            // new GoogleGenerativeAI(í‚¤): AI í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            const genAI = new GoogleGenerativeAI(import.meta.env.VITE_GEMINI_KEY);

            // getGenerativeModel: ì–´ë–¤ AI ëª¨ë¸ì„ ì“¸ì§€ ì„ íƒ
            // gemini-2.5-flash: ë¹ ë¥´ê³  ê°€ë²¼ìš´ ë²„ì „
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

            // -----------------------------------------------------------------
            // Step 2: í”„ë¡¬í”„íŠ¸ ì‘ì„± (AIì—ê²Œ ë³´ë‚¼ ì§ˆë¬¸)
            // -----------------------------------------------------------------

            // ë°±í‹±(``): í…œí”Œë¦¿ ë¦¬í„°ëŸ´ - ë¬¸ìì—´ ì•ˆì— ${ë³€ìˆ˜} ë„£ê¸° ê°€ëŠ¥
            // ${temp}: ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ ê¸°ì˜¨ê°’ì´ ì—¬ê¸° ë“¤ì–´ê°
            const prompt = `í˜„ì¬ ì„œìš¸ ê¸°ì˜¨ì´ ì„­ì”¨ ${temp}ë„ì•¼. ì´ ë‚ ì”¨ì— ì–´ìš¸ë¦¬ëŠ” í•œêµ­ì˜ 20ëŒ€ ë‚¨ì„± ì˜·ì°¨ë¦¼ì„ 3ì¤„ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ì¶”ì²œí•´ì¤˜. ë§íˆ¬ëŠ” ì¹œê·¼í•œ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ì²˜ëŸ¼ í•´ì¤˜.`;

            // -----------------------------------------------------------------
            // Step 3: AIì—ê²Œ ì§ˆë¬¸í•˜ê³  ë‹µë³€ ë°›ê¸°
            // -----------------------------------------------------------------

            // generateContent(prompt): AIì—ê²Œ ì§ˆë¬¸ ì „ì†¡
            // await: ë‹µë³€ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ (ë³´í†µ 1~3ì´ˆ)
            const result = await model.generateContent(prompt);

            // result.response: ì‘ë‹µ ê°ì²´
            const response = await result.response;

            // response.text(): ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
            const text = response.text();

            // -----------------------------------------------------------------
            // Step 4: ê²°ê³¼ë¥¼ Stateì— ì €ì¥
            // -----------------------------------------------------------------

            // setAiRecommendation(text): aiRecommendation ìƒíƒœë¥¼ AI ë‹µë³€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            // ì´ë ‡ê²Œ í•˜ë©´ Reactê°€ ìë™ìœ¼ë¡œ í™”ë©´ì„ ë‹¤ì‹œ ê·¸ë¦¼!
            setAiRecommendation(text);

        } catch (error) {
            // catch: try ë¸”ë¡ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì—¬ê¸°ë¡œ ì˜´
            // ì—ëŸ¬ ì›ì¸: API í‚¤ ë¬¸ì œ, ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ, ìš”ì²­ í•œë„ ì´ˆê³¼ ë“±
            console.error("AI ì¶”ì²œ ì‹¤íŒ¨:", error);

            // ì—ëŸ¬ê°€ ë‚˜ë„ ì•±ì´ ì£½ì§€ ì•Šê²Œ ì¹œì ˆí•œ ë©”ì‹œì§€ í‘œì‹œ
            setAiRecommendation("AI ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ê°€ ì ì‹œ ìë¦¬ë¥¼ ë¹„ì› ì–´ìš”. ğŸ˜…");
        }
    };

    // ===================================================================
    // 6. í•¨ìˆ˜ B: í™”ë©´ ê´€ë¦¬ì (fetchWeather)
    // ===================================================================
    // ğŸ¯ ì—­í• : ì „ì²´ íë¦„ ê´€ë¦¬ (ë¡œë”© â†’ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° â†’ AI í˜¸ì¶œ â†’ ì €ì¥)
    // ğŸ“ ì´ í•¨ìˆ˜ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ í•¨ìˆ˜!

    const fetchWeather = async () => {
        try {
            // -----------------------------------------------------------------
            // Step 1: ì´ˆê¸°í™” ì‘ì—…
            // -----------------------------------------------------------------

            setLoading(true);           // ë¡œë”© ì‹œì‘ (í™”ë©´ì— "ë¡œë”© ì¤‘..." í‘œì‹œ)
            setError(null);             // ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ ì§€ìš°ê¸°
            setCurrentTemp(null);       // ì´ì „ ê¸°ì˜¨ ë°ì´í„° ì§€ìš°ê¸°
            setHourlyTemps([]);         // ì´ì „ ì‹œê°„ë³„ ë°ì´í„° ì§€ìš°ê¸°
            setAiRecommendation(null);  // ì´ì „ AI ì¶”ì²œ ì§€ìš°ê¸°

            // -----------------------------------------------------------------
            // Step 2: ë‚ ì”¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            // -----------------------------------------------------------------

            // getWeatherData(): ìœ„ì—ì„œ ë§Œë“  í•¨ìˆ˜ í˜¸ì¶œ
            // await: ë°ì´í„° ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            const data = await getWeatherData();

            // -----------------------------------------------------------------
            // Step 3: ë°›ì€ ë°ì´í„°ë¥¼ Stateì— ì €ì¥
            // -----------------------------------------------------------------

            // data.current_weather.temperature: í˜„ì¬ ê¸°ì˜¨ (ì˜ˆ: 3.2)
            setCurrentTemp(data.current_weather.temperature);

            // data.hourly.temperature_2m: ì‹œê°„ë³„ ê¸°ì˜¨ ë°°ì—´ (24ê°œ ë˜ëŠ” 168ê°œ)
            setHourlyTemps(data.hourly.temperature_2m);

            // -----------------------------------------------------------------
            // Step 4: AIì—ê²Œ ì˜·ì°¨ë¦¼ ì¶”ì²œ ì˜ë¢°
            // -----------------------------------------------------------------

            // â˜… ì¤‘ìš”: awaitë¥¼ ë¶™ì´ì§€ ì•ŠìŒ!
            // ì™œ? ë‚ ì”¨ê°€ ë¨¼ì € í™”ë©´ì— ëœ¨ê³ , AI ë‹µë³€ì€ ë‚˜ì¤‘ì— ëœ¨ê²Œ í•˜ë ¤ê³ 
            // ì´ê±¸ "Fire and Forget" íŒ¨í„´ì´ë¼ê³  í•¨
            getAiRecommendation(data.current_weather.temperature);

        } catch (err) {
            // ì—ëŸ¬ ë°œìƒ ì‹œ (ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë“±)
            setError("ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } finally {
            // finally: ì„±ê³µí•˜ë“  ì‹¤íŒ¨í•˜ë“  ë¬´ì¡°ê±´ ì‹¤í–‰
            // ë¡œë”© ìƒíƒœë¥¼ ëë‚´ì•¼ í™”ë©´ì—ì„œ ë¡œë”© í‘œì‹œê°€ ì‚¬ë¼ì§
            setLoading(false);
        }
    };

    // ===================================================================
    // 7. í›…ì˜ ë°˜í™˜ê°’ (ì™¸ë¶€ì— ë…¸ì¶œí•  ê²ƒë“¤)
    // ===================================================================
    // ì´ í›…ì„ ì‚¬ìš©í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì—ê²Œ í•„ìš”í•œ ê²ƒë“¤ë§Œ ì œê³µ
    // getWeatherDataë‚˜ getAiRecommendationì€ ë‚´ë¶€ êµ¬í˜„ì´ë¼ ìˆ¨ê¹€!

    // return { ... }: ê°ì²´ í˜•íƒœë¡œ ë°˜í™˜
    // ì‚¬ìš©ë²•: const { currentTemp, fetchWeather } = useWeather();
    return {
        currentTemp,        // í˜„ì¬ ê¸°ì˜¨ (number | null)
        hourlyTemps,        // ì‹œê°„ë³„ ê¸°ì˜¨ ë°°ì—´ (number[])
        aiRecommendation,   // AI ì¶”ì²œ ë©˜íŠ¸ (string | null)
        loading,            // ë¡œë”© ì¤‘ ì—¬ë¶€ (boolean)
        error,              // ì—ëŸ¬ ë©”ì‹œì§€ (string | null)
        fetchWeather        // ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ë²„íŠ¼ì— ì—°ê²°)
    };
}
